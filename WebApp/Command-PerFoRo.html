<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<script type="text/javascript" src=./script_files/eventemitter2.min.js></script>
<script type="text/javascript" src=./script_files/roslib.min.js></script>

<script type="text/javascript" type="text/javascript">
  // Connecting to ROS
  // -----------------

  var ros = new ROSLIB.Ros({
    url : 'ws://192.168.0.101:9090'		//Use IP Address of destination
  });

  ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });

  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });

  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });

  // Publishing a Topic
  // ------------------

  var cmdVel = new ROSLIB.Topic({
    ros : ros,
    name : '/cmd_vel',
    messageType : 'geometry_msgs/Twist'
  });

  var cmdMode = new ROSLIB.Topic({
    ros : ros,
    name : '/ModePerFoRo',
    messageType : 'PerFoRoControl/MODE'
  });

  var cmdNavigate = new ROSLIB.Topic({
    ros : ros,
    name : '/NavigatePerFoRo',
    messageType : 'PerFoRoControl/NavigatePerFoRo'
  });

  var twist = new ROSLIB.Message({
    linear : {
      x : 0,
      y : 0,
      z : 0
    },
    angular : {
      x : 1,
      y : 2,
      z : 3
    }
  });

  var Mode = new ROSLIB.Message({MODE : 0});
  var Navigate = new ROSLIB.Message({command : 0});

  var JSMode = 0;

  /* This function:
   - retrieves numeric values from the text boxes
   - assigns these values to the appropriate values in the twist message
   - publishes the message to the cmd_vel topic.
  */
  function pubMessage() {
    /**
    Set the appropriate values on the twist message object according to values in text boxes
    It seems that turtlesim only uses the x property of the linear object 
    and the z property of the angular object
    **/
    var linear = 0.0;
    var angular = 0.0;

    // get values from text input fields. Note for simplicity we are not validating.
    linear = 0 + Number(document.getElementById('linearText').value);
    angular = 0 + Number(document.getElementById('angularText').value);

    // Set the appropriate values on the message object
    twist.linear.x = linear;
    twist.angular.x = angular;

    // Publish the message 
    cmdVel.publish(twist);

    }

    function CommandMode(command) {
	if (command == 1)	{
    		// Set Manual Mode
		twist.linear.x = 1;
    		twist.linear.y = 0;
    		twist.linear.z = 0;
		Mode.MODE = 1;
	} else if (command == 2)	{
		// Set Obstacle Avoidance Mode
    		twist.linear.x = 0;
    		twist.linear.y = 1;
    		twist.linear.z = 0;
		Mode.MODE = 2;
	} else if (command == 3)	{
		// Stop Any Mode
    		twist.linear.x = 0;
    		twist.linear.y = 0;
    		twist.linear.z = 1;
		Mode.MODE = 3;
		JSMode = 0;
	}

    // Publish the message
    cmdVel.publish(twist);
    cmdMode.publish(Mode);

    }

    function NavigatePerFoRo(command) {
    	if (command == 1)	{
    		twist.angular.x = 1;
		Navigate.command = 1;
		//window.alert(1);
    	} else if (command == 2)	{
    		twist.angular.x = 2;
		Navigate.command = 2;
		//window.alert(2);
    	} else if (command == 3)	{
    		twist.angular.x = 3;
		Navigate.command = 3;
		//window.alert(3);
    	} else if (command == 4)	{
    		twist.angular.x = 4;
		Navigate.command = 4;
		//window.alert(4);
    	} else {
		twist.angular.x = 0;
		Navigate.command = 0;
        	window.alert(0);
    	}

    // Publish the message
    cmdVel.publish(twist);
    cmdNavigate.publish(Navigate);

    }
  
    function JSModeSelection(command) {
    	if (command == 1)	{
    		// Enable Joystick Mode
		JSMode = 1;
	} else	{
		// Disable Joystick Mode
    		JSMode = 0;
	}
    }

    document.onkeydown = function(evt) {
	if (JSMode == 1)	{
    		evt = evt || window.event;
    		switch (evt.keyCode) {
		case 38:
          		NavigatePerFoRo(1);
			break;
		case 40:
          		NavigatePerFoRo(2);
			break;
        	case 37:
          		NavigatePerFoRo(3);
			break;
       		case 39:
            		NavigatePerFoRo(4);
			break;
    		}
	}
    };
</script>
</head>

<body>
  <h1 align="center">PerFoRo Control Station</h1>
  <form name="Data transmit">
  <p></p>
  <table>
    <tr><td>Linear</td><td><input id="linearText" name="linearText" type="text"/></td></tr>
    <tr><td>Angular</td><td><input id="angularText" name="angularText" type="text"/></td></tr>
  </table>
  <button id="sendMsg" type="button" onclick="pubMessage()">Transmit To PerFoRo</button>
  </form>
  <p align="center">
  <button id="ModeManual" type="button" onclick="CommandMode(1)">Manual Mode</button>
  </p>
  <p align="center">
  <button id="NavigatePerFoRoFront" type="button" onclick="NavigatePerFoRo(1)">Front</button>
  <button id="NavigatePerFoRoBack" type="button" onclick="NavigatePerFoRo(2)">Back</button>
  <button id="NavigatePerFoRoLeft" type="button" onclick="NavigatePerFoRo(3)">Left</button>
  <button id="NavigatePerFoRoRight" type="button" onclick="NavigatePerFoRo(4)">Right</button>
  <button id="JSModeOn" type="button" onclick="JSModeSelection(1)">JS Control ON</button>
  <button id="JSModeOff" type="button" onclick="JSModeSelection(0)">JS Control OFF</button>
  </p>
  <p align="center">
  <button id="ModeObstacleAvoidance" type="button" onclick="CommandMode(2)">Obstacle Avoidance Mode</button>
  <p align="center">
  <button id="ModeStop" type="button" onclick="CommandMode(3)" style="height:25px; width:100px">STOP DEMO</button>
  <p>
  <img align="center" src="http://192.168.0.101:8080/stream?topic=/object_tracking/image_raw">
  <p>
</body>
</html>